const u="story-catalog-static-v1",c="story-catalog-dynamic-v1",g=["/","/index.html","/scripts/index.js","/styles/styles.css","/manifest.json","/images/story.png","/images/icon-512x512.png","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"];self.addEventListener("install",t=>{console.log("Service Worker: Installing..."),t.waitUntil(caches.open(u).then(o=>(console.log("Service Worker: Caching static assets"),o.addAll(g))).then(()=>self.skipWaiting()).catch(o=>{console.error("Service Worker: Failed to cache static assets",o)}))});self.addEventListener("activate",t=>{console.log("Service Worker: Activating..."),t.waitUntil(caches.keys().then(o=>Promise.all(o.map(e=>{if(e!==u&&e!==c)return console.log("Service Worker: Deleting old cache",e),caches.delete(e)}))).then(()=>self.clients.claim()))});self.addEventListener("fetch",t=>{const{request:o}=t,e=new URL(o.url);if(o.method==="GET"){if(e.origin==="https://story-api.dicoding.dev"){t.respondWith(caches.open(c).then(n=>fetch(o).then(i=>{if(i.status===200){const a=i.clone();n.put(o,a).catch(s=>{console.warn("Failed to cache API response:",s)})}return i}).catch(()=>n.match(o).then(i=>i?(console.log("Serving cached API response for:",o.url),i):new Response(JSON.stringify({error:!0,message:"You are offline. Please check your connection."}),{status:503,headers:{"Content-Type":"application/json"}})))));return}t.respondWith(fetch(o).then(n=>{if(o.url.startsWith(self.location.origin)&&n.status===200){const i=n.clone();caches.open(c).then(a=>{a.put(o,i).catch(s=>{console.warn("Failed to cache response:",s)})})}return n}).catch(()=>caches.match(o).then(n=>{var i;return n||(o.destination==="document"||(i=o.headers.get("accept"))!=null&&i.includes("text/html")?caches.match("/index.html"):new Response("Offline - No cached content available",{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"text/plain"}}))})))}});self.addEventListener("push",t=>{console.log("Service worker pushing...");async function o(){var a,s,r,l,d;let e={title:"New Notification",options:{body:"New data has been added."}};if(t.data)try{e=await t.data.json(),console.log("Push data received:",e)}catch{console.log("No JSON data in push, using default")}const n=e.title||"New Notification",i=((a=e.options)==null?void 0:a.body)||e.body||"New data has been added.";await self.registration.showNotification(n,{body:i,icon:((s=e.options)==null?void 0:s.icon)||"/images/story.png",badge:((r=e.options)==null?void 0:r.badge)||"/images/story.png",data:((l=e.options)==null?void 0:l.data)||{},tag:((d=e.options)==null?void 0:d.tag)||"story-notification",vibrate:[200,100,200],requireInteraction:!0,actions:[{action:"view",title:"View"},{action:"close",title:"Close"}]})}t.waitUntil(o())});self.addEventListener("notificationclick",t=>{console.log("Service Worker: Notification click event",t),t.notification.close();const o=t.action,e=t.notification.data;if(o==="close")return;let n=(e==null?void 0:e.url)||"/#/stories";o==="view"&&(e!=null&&e.storyId)&&(n=`/#/stories/${e.storyId}`),t.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(i=>{for(const a of i)if(a.url.includes(n.split("#")[1])&&"focus"in a)return a.focus();if(i.openWindow){const a=self.location.origin;return i.openWindow(a+n)}}))});self.addEventListener("message",t=>{if(console.log("Service Worker: Message received",t.data),t.data&&t.data.type==="SHOW_NOTIFICATION"){const{title:o,options:e}=t.data;t.waitUntil(self.registration.showNotification(o||"New Notification",{body:(e==null?void 0:e.body)||"New data has been added.",icon:(e==null?void 0:e.icon)||"/images/story.png",badge:(e==null?void 0:e.badge)||"/images/story.png",data:(e==null?void 0:e.data)||{},tag:(e==null?void 0:e.tag)||"story-notification",vibrate:[200,100,200],requireInteraction:!0,actions:[{action:"view",title:"View"},{action:"close",title:"Close"}]}))}});self.addEventListener("sync",t=>{console.log("Service Worker: Background sync event",t.tag),t.tag==="background-sync"&&t.waitUntil(Promise.resolve().then(()=>{console.log("Background sync completed")}))});
